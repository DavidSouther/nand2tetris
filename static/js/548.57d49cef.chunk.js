"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[548],{7070:(t,e,s)=>{s.r(e),s.d(e,{CPU:()=>A,default:()=>P});var a=s(5072),n=s(4619),r=s(3478),i=s(1062),c=s(8963),l=s(7054),o=s(2201),d=s(4430),u=s(1003);const p=new Int16Array([2,55944,0,64528,15,54018,1,64528,2,61584,54024,0,64648,2,55943,15,55943]);var h=s(6845),m=s(4913),x=s(6604),b=s(5692);class j extends o.kG{dispatch;constructor(t,e){super(t,t.size,0),this.dispatch=e}async load(t,e){await super.load(t,e),this.dispatch.current({action:"update"})}}function g(t,e){const s=new j(t.cpu.RAM,e),a=new j(t.cpu.ROM,e),n=new j(t.cpu.Screen,e),r=new o.qT(new j(t.cpu.RAM,e));return{A:t.cpu.A,D:t.cpu.D,PC:t.cpu.PC,RAM:s,ROM:a,Screen:n,Keyboard:r}}function f(){const{fs:t,setStatus:e,storage:s}=(0,h.useContext)(b.r),a=(0,h.useRef)((()=>{})),{initialState:n,reducers:r,actions:i}=(0,h.useMemo)((()=>function(t,e,s,a){let n=new u.o(new o.eD(p)),r=!0;const i={update(t){t.sim=g(n,a),t.test.highlight=n.currentStep?.span},setTest(t,e){let{tst:s,cmp:a}=e;t.test.tst=s??t.test.tst,t.test.cmp=a??t.test.cmp,t.test.out=""},testStep(t){t.test.out=n.log(),this.update(t)},testFinished(t){if(""===t.test.cmp.trim())return;const s=(0,m.q)(t.test.cmp.trim(),n.log().trim());e(s?"Simulation successful: The output file is identical to the compare file":"Simulation error: The output file differs from the compare file")}},c={tick(){n.cpu.tick()},setAnimate(t){r=t},testStep(){const t=n.step();return(r||t)&&a.current({action:"testStep"}),t&&a.current({action:"testFinished"}),t},resetRAM(){n.cpu.RAM.loadBytes([]),a.current({action:"update"}),e("Reset RAM")},toggleUseTest(){a.current({action:"update"})},resetCPU(){n.reset(),a.current({action:"setTest",payload:{}}),a.current({action:"update"}),e("Reset CPU")},reset(){this.resetCPU(),e("Reset CPU & RAM")},compileTest(t,s){a.current({action:"setTest",payload:{tst:t,cmp:s}});const r=d.qH.parse(t);return(0,l.dZ)(r)?(e("Failed to parse test"),!1):(e("Parsed tst"),n=u.o.from((0,l.Ok)(r),n.cpu.ROM),a.current({action:"update"}),!0)},initialize(){this.compileTest("repeat {\n  ticktock;\n}")}};return{initialState:{sim:g(n,a),test:{highlight:n.currentStep?.span,tst:"",cmp:"",out:""}},reducers:i,actions:c}}(0,e,0,a)),[t,e,s,a]),[c,j]=(0,x.C)(r,n);return a.current=j,{state:c,dispatch:a,actions:i}}var C=s(6791),S=s(8722),y=s(8398),v=s(1965),k=s(7880),R=s(9200),M=s(864);const w=t=>{let{runner:e,tst:[s,n,r],cmp:[i,c],out:[l],disabled:o=!1,onLoadTest:u,onSpeedChange:p}=t;const{fs:m,setStatus:x}=(0,h.useContext)(b.r),{filePicker:j,tracking:g}=(0,h.useContext)(S.Il),[f,w]=(0,h.useState)("tst"),A=(0,h.useCallback)((t=>{w(t),g.trackEvent("tab","change",t)}),[g]),P=(0,h.useCallback)((async()=>{try{const e=await j.select(),s=await m.readFile(e);let a;try{a=await m.readFile(e.replace(/\.tst$/,".cmp"))}catch(t){}null===u||void 0===u||u(s,a)}catch(t){console.error(t),x("Failed to load test")}}),[j,x,m]);return(0,M.jsx)(y.s,{className:"_test_panel",header:(0,M.jsxs)(M.Fragment,{children:[(0,M.jsx)("div",{className:"flex-0",children:(0,M.jsx)(a.cC,{id:"Test"})}),(0,M.jsx)("div",{className:"flex-1",children:e.current&&(0,M.jsx)(C.D,{runner:e.current,onSpeedChange:p})}),(0,M.jsx)("div",{children:(0,M.jsx)("fieldset",{role:"group",children:(0,M.jsx)("button",{onClick:P,children:"\ud83d\udcc2"})})})]}),children:(0,M.jsxs)("div",{role:"tablist",style:{"--tab-count":"3"},children:[(0,M.jsx)("div",{role:"tab",id:"test-tab-tst","aria-controls":"test-tabpanel-tst","aria-selected":"tst"===f,children:(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-tst",value:"tst",checked:"tst"===f,onChange:()=>A("tst")}),"Test Script"]})}),(0,M.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-tst",id:"test-tabpanel-tst",children:(0,M.jsx)(R.M,{value:s,onChange:n,grammar:d.qH.parser,language:"tst",highlight:r,disabled:o})}),(0,M.jsx)("div",{role:"tab",id:"test-tab-cmp","aria-controls":"test-tablpanel-cmp","aria-selected":"cmp"===f,children:(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-cmp",value:"cmp",checked:"cmp"===f,onChange:()=>A("cmp")}),"Compare File"]})}),(0,M.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-cmp",id:"test-tabpanel-cmp",style:{position:"relative"},children:(0,M.jsx)(R.M,{value:i,onChange:c,grammar:k.lA.parser,language:"cmp",disabled:o})}),(0,M.jsx)("div",{role:"tab",id:"test-tab-out","aria-controls":"test-tabpanel-out","aria-selected":"out"===f,children:(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-out",value:"out",checked:"out"===f,onChange:()=>A("out")}),"Output File"]})}),(0,M.jsx)("div",{role:"tabpanel",id:"test-tabpanel-out","aria-labelledby":"test-tab-out",children:(0,M.jsx)(v.M,{cmp:i,out:l})})]})})},A=()=>{const{state:t,actions:e,dispatch:s}=f(),{toolStates:l}=(0,h.useContext)(S.Il),[o,d]=(0,x.i)(t.test.tst),[u,p]=(0,x.i)(t.test.out),[m,b]=(0,x.i)(t.test.cmp),[j,g]=(0,h.useState)(),[v,k]=(0,h.useState)("asm"),[R,A]=(0,h.useState)(!0),[P,T]=(0,h.useState)(0);(0,h.useEffect)((()=>{e.initialize()}),[e]),(0,h.useEffect)((()=>{l.cpuState.rom&&(t.sim.ROM.loadBytes(l.cpuState.rom),l.cpuState.name&&(g(l.cpuState.name),l.cpuState.name.endsWith(".hack")&&k("bin")))}),[]),(0,h.useEffect)((()=>{l.setCpuState(j,Array.from(t.sim.ROM.map(((t,e)=>e))))}),[t]);const F=(0,h.useRef)(),O=(0,h.useRef)(),[D,E]=(0,h.useState)(!1);(0,h.useEffect)((()=>(F.current=new class extends n.B{async tick(){return e.tick(),!1}finishFrame(){s.current({action:"update"})}reset(){e.reset()}toggle(){s.current({action:"update"})}},O.current=new class extends n.B{async tick(){return e.testStep()}finishFrame(){s.current({action:"update"})}reset(){e.reset()}toggle(){s.current({action:"update"})}},E(!0),()=>{var t,e;null===(t=F.current)||void 0===t||t.stop(),null===(e=O.current)||void 0===e||e.stop()})),[e,s]);return(0,M.jsxs)("div",{className:"Page CpuPage grid",children:[(0,M.jsx)(i.ZP,{name:"ROM",displayEnabled:R,memory:t.sim.ROM,highlight:t.sim.PC,format:v,onUpload:t=>{g(t),e.reset()}}),(0,M.jsx)(i.ZP,{name:"RAM",displayEnabled:R,memory:t.sim.RAM,format:"hex",onChange:()=>{T(P+1)}}),(0,M.jsxs)(y.s,{className:"IO",header:(0,M.jsxs)(M.Fragment,{children:[j&&(0,M.jsx)("div",{className:"flex-0",children:j}),(0,M.jsx)("div",{className:"flex-1",children:D&&F.current&&(0,M.jsx)(C.D,{runner:F.current})})]}),children:[(0,M.jsx)(c.l,{memory:t.sim.Screen},P),(0,M.jsx)(r.N,{update:()=>{s.current({action:"update"})},keyboard:t.sim.Keyboard}),(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"checkbox",role:"switch",checked:R,onChange:()=>{A(!R)}}),(0,M.jsx)(a.cC,{id:"{0}",values:{0:R?"Disable display":"Enable display"}})]}),R&&(0,M.jsx)("div",{children:(0,M.jsxs)("dl",{children:[(0,M.jsx)("dt",{children:"PC"}),(0,M.jsx)("dd",{children:t.sim.PC}),(0,M.jsx)("dt",{children:"A"}),(0,M.jsx)("dd",{children:t.sim.A}),(0,M.jsx)("dt",{children:"D"}),(0,M.jsx)("dd",{children:t.sim.D})]})})]}),D&&(0,M.jsx)(w,{runner:O,tst:[o,d,t.test.highlight],out:[u,p],cmp:[m,b],onLoadTest:(t,s)=>{e.compileTest(t,s)},onSpeedChange:t=>{e.setAnimate(t<=2)}})]})},P=A}}]);