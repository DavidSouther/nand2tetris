"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[318],{3478:(t,e,n)=>{n.d(e,{N:()=>c});var s=n(864),r=n(6845),i=n(2869);const a={Enter:128,Backspace:129,ArrowLeft:130,ArrowUp:131,ArrowRight:132,ArrowDown:133,Home:134,End:135,PageUp:136,PageDown:137,Insert:138,Delete:139,Escape:140,F1:141,F2:142,F3:143,F4:144,F5:145,F6:146,F7:147,F8:148,F9:149,F10:150,F11:151,F12:152},o={ArrowLeft:"L-arrow",ArrowUp:"U-arrow",ArrowRight:"R-arrow",ArrowDown:"D-arrow"};const c=t=>{let{keyboard:e,update:n}=t;const[c,l]=(0,r.useState)(!1),[u,d]=(0,r.useState)(""),[h,p]=(0,r.useState)(e.getKey());let m=0;const g=t=>{if(!c)return;d(function(t){return o[t]??t}(t.key));const e=function(t){const e=a[t.key];if(void 0!==e)return e;if(1===t.key.length){const e=t.key.charCodeAt(0);if(e>=32&&e<=126)return e}return 0}(t);e!==m&&(x(e),n?.())},f=t=>{c&&(m=0,e.clearKey(),n?.(),p(e.getKey()),d(""))},x=t=>{0!==t&&(e.setKey(t),p(e.getKey()),m=t)};return(0,r.useEffect)((()=>(window.addEventListener("keydown",g),window.addEventListener("keyup",f),()=>{window.removeEventListener("keydown",g),window.removeEventListener("keyup",f)}))),(0,s.jsxs)("div",{className:"flex row align-baseline",children:[(0,s.jsx)("div",{className:"flex-2",children:(0,s.jsx)(i.y,{name:"Key",bits:h})}),(0,s.jsxs)("div",{className:"flex-2",children:["Char: ",u]}),(0,s.jsx)("div",{className:"flex-3",children:(0,s.jsx)("button",{onClick:()=>{l(!c)},children:(c?"Disable":"Enable")+" Keyboard"})})]})}},1062:(t,e,n)=>{n.d(e,{zp:()=>k,ZP:()=>w});var s=n(864),r=n(4089),i=n(6845),a=n(2201),o=n(6699),c=n(6871),l=n(5150),u=n(5554),d=n(5251);var h=n(6604);const p=0,m=1,g=t=>{const[e,n]=(0,i.useState)(t.mode??p),[r,a]=(0,h.i)(t.value),o=()=>{return(0,s.jsx)("span",{style:{cursor:"text",...(t="full",e="inline",void 0===t&&void 0!==d.BM[e]&&(t=e),{..."inline"===e?{display:"inline-block"}:{},width:d.BM[t]??"0"})},onClick:()=>{n(m)},children:r});var t,e},c=(0,i.useCallback)((t=>t?.select()),[]),l=(0,i.useCallback)((e=>{n(p),a(e.value??""),t.onChange(e.value??"")}),[t,n,a]),u=()=>(0,s.jsx)("span",{style:{display:"block",position:"relative"},children:(0,s.jsx)("input",{ref:c,style:{zIndex:"10",position:"absolute",left:"0",marginTop:"-0.375rem",color:"var(--text-color)"},onFocus:t.onFocus,onBlur:t=>{let{target:e}=t;return l(e)},onKeyPress:t=>{let{key:e,target:n}=t;"Enter"===e&&l(n)},type:"text",defaultValue:r})});return(()=>{switch(e){case m:return u();case p:return o();default:return(0,s.jsx)("span",{})}})()};var f=n(5692);function x(t,e,n){const{totalHeight:s,toleranceHeight:r,bufferedItems:i,settings:{itemHeight:a,minIndex:o,maxIndex:c}}=e,l=o+Math.floor((t-r)/a),u=function(t,e,n,s,r){const i=Math.max(0,t,n);return[...r(i,Math.min(e,n+s-1)-i)]}(o,c,l,i,n),d=Math.max((l-o)*a,0);return{scrollTop:t,topPaddingHeight:d,bottomPaddingHeight:Math.max(s-(d+u.length*a),0),data:u}}const b=t=>{const e=(0,i.useRef)(null),{settings:n,startState:r,reducer:a}=(0,i.useMemo)((()=>{const e=function(t){const{minIndex:e=0,maxIndex:n=Number.MAX_SAFE_INTEGER,startIndex:s=0,itemHeight:r=20,count:i=Math.max(n-e,1),tolerance:a=i}=t;return{minIndex:e,maxIndex:n,startIndex:s,itemHeight:r,count:i,tolerance:a}}(t.settings??{}),n=function(t,e){const{minIndex:n,maxIndex:s,startIndex:r,itemHeight:i,count:a,tolerance:o}=t,c=a+2*o,l=Math.max(0,r-o-n),u=a*i,d=Math.max(s-n,1)*i,h=o*i,p=l*i,m={scrollTop:0,settings:t,viewportHeight:u,totalHeight:d,toleranceHeight:h,bufferedItems:c,topPaddingHeight:p,bottomPaddingHeight:d-(p+(u+2*h)),data:[]};return{...m,...x(p+h,m,e)}}(e,t.get),s=(r=t.get,(t,e)=>({...t,...x(e,t,r)}));var r;return{settings:e,reducer:s,startState:n}}),[t.settings,t.get]),[o,c]=(0,i.useReducer)(a,r);(0,i.useEffect)((()=>{null!==e.current&&c(e.current.scrollTop)}),[n,t.row]);const l=(0,i.useCallback)((t=>{t&&(t.scrollTop=e.current?e.current.scrollTop:n.startIndex*n.itemHeight),e.current=t}),[e,n.startIndex,n.itemHeight]),u=o.data.map((e=>(0,s.jsx)("div",{style:{height:`${n.itemHeight}px`},children:t.row(e)},t.rowKey(e))));return(0,s.jsxs)("div",{ref:l,style:{height:`${o.viewportHeight}px`,overflowY:"scroll",overflowAnchor:"none"},className:t.className??"",onScroll:t=>c(t.target.scrollTop),children:[(0,s.jsx)("div",{style:{height:`${o.topPaddingHeight}px`}}),u,(0,s.jsx)("div",{style:{height:`${o.bottomPaddingHeight}px`}})]})},v=t=>{let{memory:e,jmp:n={value:0},highlight:r=-1,editable:a=!1,justifyLeft:o=!1,format:c=l.E_,onChange:u=(()=>{}),onFocus:d=(()=>{})}=t;const h=(0,i.useMemo)((()=>({count:Math.min(e.size,25),maxIndex:e.size,itemHeight:34,startIndex:n.value})),[e.size,n]),p=(0,i.useCallback)(((t,n)=>e.range(t,t+n).map(((e,n)=>[n+t,e]))),[e]),m=(0,i.useCallback)((t=>{let[n,i]=t;return(0,s.jsx)(y,{index:n,value:c(i),size:e.size,editable:a,justifyLeft:o,highlight:n===r,onChange:u,onFocus:d})}),[c,a,r,u]);return(0,s.jsx)(b,{settings:h,get:p,row:m,rowKey:t=>{let[e]=t;return e}})},y=t=>{let{index:e,value:n,size:i,highlight:a=!1,editable:o=!1,justifyLeft:c=!1,onChange:u=(()=>{}),onFocus:d=(()=>{})}=t;return(0,s.jsxs)("div",{style:{display:"flex",height:"100%"},children:[(0,s.jsx)("code",{style:{...(0,r.eP)("none"),...a?{background:"var(--mark-background-color)"}:{},whiteSpace:"pre"},children:i?(0,l.E_)(e).padStart(Math.ceil(Math.log10(i))," "):(0,l.E_)(e)}),(0,s.jsx)("code",{style:{flex:"1",textAlign:c?"left":"right",color:"var(--text-color)",...(0,r.eP)("none"),...a?{background:"var(--mark-background-color)"}:{}},children:o?(0,s.jsx)(g,{value:n,highlight:a,onChange:t=>u(e,t,Number(n)),onFocus:()=>d(e)}):(0,s.jsx)("span",{style:{color:"var(--text-color)"},children:n})})]})},k=t=>{let{name:e="Memory",displayEnabled:n=!0,highlight:r=-1,editable:d=!0,memory:p,format:m="dec",onUpload:g,onChange:x}=t;const[b,y]=(0,h.i)(m),[k,w]=(0,i.useState)(""),[S,j]=(0,i.useState)({value:0}),[A,C]=(0,h.i)(r),[I,T]=(0,i.useState)(0),O=()=>{const t=!isNaN(parseInt(k))&&isFinite(parseInt(k))?Number(k):0;C(t),j({value:t})},P=(0,i.useRef)(null),M=(0,i.useCallback)((()=>{x?.(),P.current?.click()}),[P]),{setStatus:R}=(0,i.useContext)(f.r),L=(0,i.useCallback)((async t=>{if(!t.target.files?.length)return void R("No file selected");const e=t.target.files[0];g?.(e.name);const n=await e.text(),s=e.name.endsWith("hack")?o.$W:e.name.endsWith("asm")?o.eC:o.uC,r=await s(n);p.loadBytes(r),t.target.value="",y(e.name.endsWith("hack")?"bin":e.name.endsWith("asm")?"asm":b),O()}),[]),F=()=>{T(I+1)};return(0,u._W)((()=>{w(""),j({value:0})})),(0,s.jsxs)("article",{className:`panel memory ${e}`,children:[(0,s.jsxs)("header",{children:[(0,s.jsx)("div",{children:e}),(0,s.jsxs)("fieldset",{role:"group",children:[(0,s.jsx)("input",{type:"file",style:{display:"none"},ref:P,onChange:L}),(0,s.jsx)("button",{onClick:M,className:"flex-0","data-tooltip":"Load file","data-placement":"bottom",children:"\ud83d\udcc2"}),(0,s.jsx)("button",{onClick:()=>{p.reset(),x?.(),F()},className:"flex-0","data-tooltip":"Clear","data-placement":"bottom",children:"\ud83c\udd91"}),(0,s.jsx)("input",{style:{width:"4em",height:"100%"},placeholder:"Addr",value:k,onKeyDown:t=>{let{key:e}=t;return"Enter"===e&&O()},onChange:t=>{let{target:{value:e}}=t;return w(e)}}),(0,s.jsx)("button",{onClick:O,className:"flex-0","data-tooltip":"Scroll to address","data-placement":"bottom",children:"\u2935\ufe0f"}),(0,s.jsx)("select",{value:b,onChange:t=>y(t.target.value),children:a.I2.map((t=>(0,s.jsx)("option",{children:t},t)))})]})]}),n?(0,s.jsx)(v,{jmp:S,memory:p,highlight:A,editable:d,justifyLeft:"asm"==b,format:t=>function(t,e){switch(t){case"bin":return(0,l.Ly)(e);case"hex":return(0,l.$v)(e);case"asm":return(0,c.a)(e);default:return(0,l.E_)(e)}}(b,t),onChange:(t,e)=>{p.update(t,e,b??"dec"),x?.(),F()},onFocus:t=>C(t)},I):"Memory display is disabled"]})},w=k},2869:(t,e,n)=>{n.d(e,{y:()=>i});var s=n(864),r=n(5150);const i=t=>{let{name:e,bits:n}=t;return(0,s.jsxs)("div",{children:[e,": ",(0,r.E_)(n)]})}},8963:(t,e,n)=>{n.d(e,{l:()=>l});var s=n(864),r=n(7239),i=n(6845),a=n(5554);const o="white";function c(t,e,n,s){const r=4*(512*n+e),i=s===o?255:0;t[r]=i,t[r+1]=i,t[r+2]=i,t[r+3]=255}const l=t=>{let{memory:e}=t;const n=(0,i.useRef)(),l=(0,i.useCallback)((()=>{const t=n.current?.getContext("2d")??void 0;t&&function(t,e){const n=(0,r.kP)(t.getImageData(0,0,512,256),"Failed to create Context2d");for(let r=0;r<512;r++)for(let t=0;t<256;t++){const a=(s=r,i=t,0===(e.get(32*i+(s/16|0))&1<<s%16)?o:"black");c(n.data,r,t,a)}var s,i;t.putImageData(n,0,0)}(t,e)}),[e]),u=(0,i.useCallback)((t=>{n.current=t??void 0,l()}),[n,l]);return(0,a.RC)(l),(0,a._W)((()=>{n.current?.getContext("2d")?.clearRect(0,0,n.current.width,n.current.height)})),(0,s.jsxs)("article",{className:"panel",children:[(0,s.jsx)("header",{children:"Screen"}),(0,s.jsx)("main",{style:{backgroundColor:"var(--code-background-color)"},children:(0,s.jsx)("figure",{style:{width:"100%",maxWidth:"512px",boxSizing:"content-box",marginInline:"auto",margin:"auto",borderTop:"2px solid gray",borderLeft:"2px solid gray",borderBottom:"2px solid lightgray",borderRight:"2px solid lightgray"},children:(0,s.jsx)("canvas",{ref:u,width:512,height:256})})})]})}},5554:(t,e,n)=>{n.d(e,{RC:()=>o,_W:()=>c,uY:()=>u});var s=n(864),r=n(6845),i=n(554),a=n(5424);function o(t){(0,r.useEffect)((()=>{const e=a.S.get().frame$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function c(t){(0,r.useEffect)((()=>{const e=a.S.get().reset$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function l(){return(0,i.j)(a.S.get())}const u=()=>{const t=function(){const[t,e]=(0,r.useState)(l());return(0,r.useEffect)((()=>{const t=a.S.get().$.subscribe((()=>{e(l())}));return()=>t.unsubscribe()}),[]),t}();return(0,s.jsx)("span",{style:{whiteSpace:"nowrap"},children:t})}},4913:(t,e,n)=>{n.d(e,{q:()=>i});var s=n(7054),r=n(7880);const i=(t,e)=>{const n=r.lA.parse(t),i=r.lA.parse(e);if((0,s.dZ)(n)||(0,s.dZ)(i))return!1;const a=(0,s.Ok)(n),o=(0,s.Ok)(i);for(let s=0;s<Math.min(a.length,o.length);s++){const t=a[s]??[],e=o[s]??[];for(let n=0;n<Math.max(t.length,e.length);n++){const s=t[n]??"",r=e[n]??"";if(null===s?.trim().match(/^\*+$/)&&r?.trim()!==s?.trim())return!1}}return!0}},1965:(t,e,n)=>{n.d(e,{M:()=>c});var s=n(864),r=n(7880),i=n(554),a=n(8177),o=n(7054);const c=t=>{let{className:e="",out:n,cmp:c,zeroState:u}=t;const d=r.lA.parse(n),h=r.lA.parse(c);if((0,o.dZ)(d))return(0,s.jsxs)("details",{children:[(0,s.jsx)("summary",{children:"Failed to parse output"}),(0,s.jsx)("pre",{children:(0,i.j)((0,o.UG)(d))}),(0,s.jsx)("code",{children:(0,s.jsx)("pre",{children:n})})]});if((0,o.dZ)(h))return(0,s.jsxs)("details",{children:[(0,s.jsx)("summary",{children:"Failed to parse compare"}),(0,s.jsxs)("code",{children:[(0,s.jsx)("pre",{children:(0,i.j)((0,o.UG)(h))}),(0,s.jsx)("pre",{children:c})]})]});const p=(0,o.Ok)(h),m=(0,o.Ok)(d);let g=0;const f=(0,a.w)(0,Math.min(p.length,m.length)).map((t=>{const e=p[t]??[],n=m[t]??[];return(0,a.w)(0,Math.max(e.length,n.length)).map(((t,s)=>[e[s]??"",n[s]??""])).map((t=>{let[e,n]=t;const s={cmp:e??'"',out:n??'"',pass:null!==e?.trim().match(/^\*+$/)||n?.trim()===e?.trim()};return s.pass||(g+=1),s}))}));return(0,s.jsxs)("div",{className:"scroll-x "+e,children:[g>0&&(0,s.jsxs)("p",{children:[g," failure",1===g?"":"s"]}),f.length>0?(0,s.jsx)("table",{style:{fontFamily:"var(--font-family-monospace)",marginBottom:"none"},children:(0,s.jsx)("tbody",{children:f.map(((t,e)=>(0,s.jsx)("tr",{children:t.map(((t,e)=>{let{cmp:n,out:r,pass:i}=t;return(0,s.jsx)(l,{cmp:n,out:r,pass:i},e)}))},e)))})}):u??(0,s.jsx)("p",{children:"Execute test script to compare output."})]})},l=t=>{let{cmp:e,out:n,pass:r}=t;return r?(0,s.jsx)(s.Fragment,{children:(0,s.jsx)("td",{children:e})}):(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("td",{children:[(0,s.jsx)("ins",{children:e}),(0,s.jsx)("br",{}),(0,s.jsx)("del",{children:n})]})})}},554:(t,e,n)=>{n.d(e,{j:()=>s});const s=t=>{if((t=>"function"===typeof t?.toString||"string"===typeof t)(t)){const e=t.toString();return"[object Object]"===e?JSON.stringify(t):e}return JSON.stringify(t)}},2369:(t,e,n)=>{n.d(e,{Ff:()=>v,Jx:()=>x,Z9:()=>y,Zu:()=>i,aL:()=>b});var s=n(137),r=n(2201);function i(){return{A:0,D:0,PC:0,ALU:0,flag:s.vU.Zero}}const a=32768,o=36864,c=36864,l=36864,u=4032,d=32800,h=32784,p=32776,m=32769,g=32770,f=32772;function x(t){function e(e){return(t&e)===e}return{c:e(a),x1:e(o),x2:e(c),am:e(l),op:(t&u)>>6,d1:e(d),d2:e(h),d3:e(p),j1:e(m),j2:e(g),j3:e(f)}}function b(t,e){let{inM:n,instruction:r}=t,{A:i,D:a,PC:o}=e;const c=x(r),l=c.am?n:i,[u,d]=(0,s.Bb)(c.op,a,l);return[{A:i,D:a,PC:o+1,ALU:u,flag:d},c.d3]}function v(t,e){let{inM:n,instruction:r,reset:i}=t,{A:a,D:o,PC:c,ALU:l,flag:u}=e;const d=x(r),h=d.j1&&u===s.vU.Positive,p=d.j2&&u===s.vU.Zero,m=d.j3&&u===s.vU.Negative;c=i?0:h||p||m?a:c,d.d2&&(o=l);const g=a;d.c?d.d1&&(a=l):a=32767&r;const f=d.am?n:a,b=(0,s.Bb)(d.op,o,f);l=b[0],u=b[1];return[{addressM:d.d3?g:a,outM:l,writeM:d.d3},{A:a,D:o,ALU:l,flag:u,PC:c}]}class y{RAM;ROM;Screen;Keyboard;#t=0;#e=0;#n=0;#s={A:0,D:0,PC:0,ALU:0,flag:s.vU.Zero};get state(){return this.#s}get PC(){return this.#t}get A(){return this.#e}get D(){return this.#n}setA(t){this.#e=t}setD(t){this.#n=t}setPC(t){this.#t=t}constructor(t){let{RAM:e=new r.FH,ROM:n}=t;this.RAM=e,this.ROM=n,this.Screen=new r.kG(this.RAM,r.yJ,r.GD),this.Keyboard=new r.qT(this.RAM)}reset(){this.#t=0,this.#e=0,this.#n=0}tick(){const[{addressM:t,outM:e,writeM:n},{A:r,D:i,PC:a}]=function(t,e){const[n,s]=b(t,e);return v(t,n)}({inM:this.RAM.get(this.#e),instruction:this.ROM.get(this.#t),reset:!1},{A:this.#e,D:this.#n,PC:this.#t,ALU:this.#n,flag:s.vU.Zero});this.#e=r,this.#n=i,this.#t=a,n&&this.RAM.set(t,e)}}},7880:(t,e,n)=>{n.d(e,{lA:()=>c});var s=n(9814),r=n(3484);const i="\nCmp <: Base {\n  Root := line*\n  line = bar cell+ newline?\n  cell = cellvalue bar\n  cellvalue = (~(bar|newline) any)*\n}",a=s.Z.grammar(i,r.y1),o=a.extendSemantics(r.rJ);o.addAttribute("cell",{cell:(t,e)=>t.sourceString}),o.addAttribute("line",{line:(t,e,n)=>e.children.map((t=>t.cell))}),o.addAttribute("root",{Root:t=>t.children.map((t=>t.line))});const c={grammar:i,semantics:o,parser:a,parse:(0,r.Pz)(a,o)}},4430:(t,e,n)=>{n.d(e,{qH:()=>c});var s=n(9814),r=n(3484);const i='\nTst <: Base {\n  Root := Tst\n  Tst = (TstStatement | TstRepeat | TstWhile)+\n\n  TstRepeat = Repeat Number? OpenBrace TstStatement+ CloseBrace\n  TstWhile = While Condition OpenBrace TstStatement+ CloseBrace\n  TstStatement = List<TstOperation, ","> (Semi | Bang)\n\n  TstOperation =\n    | TstFileOperation\n    | TstOutputListOperation\n    | TstEvalOperation\n    | TstSetOperation\n    | TstOutputOperation\n    | TstEchoOperation\n    | TstClearEchoOperation\n    | TstLoadROMOperation\n\n  TstLoadROMOperation = ROM32K Load FileName\n  TstFileOperation = FileOperation FileName?\n  TstOutputListOperation = "output-list" OutputFormat+\n  OutputFormat = Name Index? percent FormatStyle wholeDec dot wholeDec dot wholeDec\n  TstSetOperation = Set Name Index? Number\n  Index = OpenSquare wholeDec? CloseSquare\n  Condition = Value CompareOp Value\n  TstEvalOperation = Eval | TickTock | Tick | Tock | VmStep\n  TstOutputOperation = Output\n  TstEchoOperation = Echo String\n  TstClearEchoOperation = ClearEcho\n\n  FileName = Name\n  FileOperation = "load" | "output-file" | "compare-to"\n\n  Set = "set"\n  Eval = "eval"\n  Tick = "tick"\n  Tock = "tock"\n  TickTock = "ticktock"\n  VmStep = "vmstep"\n  Echo = "echo"\n  Repeat = "repeat"\n  ClearEcho = "clear-echo"\n  Output = "output"\n  OutputList = "output-list"\n  FormatStyle = "B"|"D"|"S"|"X"\n  ROM32K = "ROM32K"\n  Load = "load"\n  While = "while"\n\n  CompareOp = "<>" | "<=" | ">=" | "=" | "<" | ">"\n}',a=s.Z.grammar(i,r.y1),o=a.extendSemantics(r.rJ);o.extendAttribute("value",{Index:(t,e,n)=>e?.child(0)?.value??-1}),o.extendAttribute("name",{FileName(t){let{name:e}=t;return e}}),o.addAttribute("index",{Index:(t,e,n)=>e.child(0)?.value??0}),o.addAttribute("format",{OutputFormat(t,e,n,s,r,i,a,o,c){let{name:l}=t,{sourceString:u}=s,{value:d}=r,{value:h}=a,{value:p}=c;return{id:l,builtin:void 0!==e?.child(0),address:e?.child(0)?.value??-1,style:u,width:h,lpad:d,rpad:p}}}),o.addAttribute("operation",{TstEvalOperation:t=>({op:t.sourceString}),TstOutputOperation:t=>({op:"output"}),TstOutputListOperation:(t,e)=>({op:"output-list",spec:e.children.map((t=>t.format))}),TstSetOperation(t,e,n,s){let{name:r}=e,{value:i}=s;const a={op:"set",id:r,value:i},o=n.child(0)?.child(1)?.child(0);return o&&(a.index=o.value),a},TstEchoOperation:(t,e)=>({op:"echo",message:e.String}),TstClearEchoOperation:t=>({op:"clear-echo"}),TstLoadROMOperation(t,e,n){let{name:s}=n;return{op:"loadRom",file:s}},TstFileOperation:(t,e)=>({op:t.sourceString,file:e?.sourceString})}),o.addAttribute("condition",{Condition(t,e,n){let{value:s}=t,{sourceString:r}=e,{value:i}=n;return{left:s,right:i,op:r}}}),o.addAttribute("statement",{TstWhile(t,e,n,s,i){return{statements:s.children.map((t=>{let{statement:e}=t;return e})),condition:e.condition,span:(0,r.yP)(this.source)}},TstRepeat(t,e,n,s,i){return{statements:s.children.map((t=>{let{statement:e}=t;return e})),count:e.sourceString?Number(e.sourceString):-1,span:(0,r.yP)(this.source)}},TstStatement(t,e){const n={ops:t.asIteration().children.map((t=>t.operation)),span:(0,r.yP)(this.source)};return"!"===e.sourceString&&(n.break=!0),n}}),o.addAttribute("tst",{Tst:t=>({lines:t.children.map((t=>t.statement))})}),o.addAttribute("root",{Root(t){let{tst:e}=t;return e}});const c={grammar:i,semantics:o,parser:a,parse:(0,r.Pz)(a,o)}},5332:(t,e,n)=>{n.d(e,{h:()=>T});var s=n(7239),r=n(2836),i=n(5150);class a{variable;fmt;lPad;rPad;len;index;builtin;constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"%B1.1.1",n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0;if(this.variable=t,e.startsWith("%")&&void 0===n&&void 0===r&&void 0===i){const{fmt:t,lPad:n,rPad:s,len:r}=e.match(/^%(?<fmt>[BDXS])(?<lPad>\d+)\.(?<len>\d+)\.(?<rPad>\d+)$/)?.groups;this.fmt=t,this.lPad=parseInt(n),this.rPad=parseInt(s),this.len=parseInt(r),this.builtin=!1,this.index=-1}else(0,s.hu)(["B","X","D","S"].includes(e[0])),this.fmt=e[0],this.len=n??3,this.lPad=r??1,this.rPad=i??1,this.builtin=a??!1,this.index=o??-1}header(t){let e=`${this.variable}`;if(this.builtin){e=`${e}[${this.index>=0?this.index:""}]`}return e.length>this.len+this.lPad+this.rPad?e.substring(0,this.len+this.lPad+this.rPad):this.padCenter(e)}print(t){const e=t.getVar(this.variable,this.index);if("S"===this.fmt)return this.padLeft(e);const n=(0,{B:i.Ly,D:i.E_,X:i.$v}[this.fmt])(e);return"D"===this.fmt?this.padRight(n):this.padCenter(n.slice(n.length-this.len))}padCenter(t){const e=this.lPad+this.len+this.rPad,n=Math.floor((e-t.length)/2),s=e-n-t.length,r=n+t.length,i=r+s;return t=(t=t.padStart(r)).padEnd(i)}padLeft(t){t=t.substring(0,this.len);const e=this.rPad+this.len,n=this.lPad+e;return t=(t=t.padEnd(e)).padStart(n)}padRight(t){t=t.substring(0,this.len);const e=this.lPad+this.len,n=this.rPad+e;return t=(t=t.padStart(e)).padEnd(n)}}class o{variable;value;index;constructor(t,e,n){this.variable=t,this.value=e,this.index=n}do(t){t.setVar(this.variable,this.value,this.index)}*steps(){yield this}}class c{do(t){t.output()}*steps(){yield this}}class l{outputs=[];constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const e of t)this.addOutput(e)}addOutput(t){this.outputs.push(new a(t.id,t.style,t.width,t.lpad,t.rpad,t.builtin,t.address))}do(t){t.outputList(this.outputs),t.header()}*steps(){yield this}}class u{instructions=[];span;addInstruction(t){this.instructions.push(t)}do(t){for(const e of this.instructions)e.do(t)}*steps(t){yield this}}class d extends u{repeat;constructor(t){super(),this.repeat=t}do(){}*innerSteps(t){for(const e of this.instructions)yield*e.steps(t)}*steps(t){if(-1===this.repeat)for(yield this;;)yield*this.innerSteps(t);else for(let e=0;e<this.repeat;e++)yield this,yield*this.innerSteps(t)}}class h{x;y;op;constructor(t,e,n){this.x=t,this.y=e,this.op=n}check(t){const e=t.hasVar(this.x)?t.getVar(this.x):this.x,n=t.hasVar(this.y)?t.getVar(this.y):this.y;if("string"===typeof e||"string"===typeof n)switch(this.op){case"=":return`${e}`===`${n}`;case"<>":return`${e}`!==`${n}`}else switch(this.op){case"<":return e<n;case"<=":return e<=n;case">":return e>n;case">=":return e>=n;case"=":return e===n;case"<>":return e!==n}return!1}}class p extends u{condition;constructor(t){super(),this.condition=t}*steps(t){for(;this.condition.check(t);){yield this;for(const e of this.instructions)yield*e.steps(t)}}}class m{content;constructor(t){this.content=t}do(t){t.echo(this.content)}*steps(){yield this}}class g{do(t){t.clearEcho()}*steps(){yield this}}class f{file;constructor(t){this.file=t}async do(t){t.fs.pushd("/samples"),await t.load(this.file),t.fs.popd()}*steps(){yield this}}n(2201);var x=n(9814),b=n(3484);const v='\nVm <: Base {\n  Root := Vm\n\n  Vm = VmInstruction*\n\n  VmInstruction =\n    | StackInstruction\n    | OpInstruction\n    | FunctionInstruction\n    | CallInstruction\n    | ReturnInstruction\n    | GotoInstruction\n    | LabelInstruction\n  \n  StackInstruction = (Push | Pop) MemorySegment Number\n  OpInstruction = Add | Sub | Neg | Lt | Gt | Eq | And | Or | Not\n  FunctionInstruction = Function Name Number \n  CallInstruction =  Call Name Number\n  ReturnInstruction = Return\n  LabelInstruction = Label Name\n  GotoInstruction = (Goto | IfGoto) Name\n\n  MemorySegment = Argument | Local | Static | Constant | This | That | Pointer | Temp\n\n  Push = "push"\n  Pop = "pop"\n  Function = "function"\n  Call = "call"\n  Return = "return"\n  Goto = "goto"\n  IfGoto = "if-goto"\n  Label = "label"\n\n  Argument = "argument"\n  Local = "local"\n  Static = "static"\n  Constant = "constant"\n  This = "this"\n  That = "that"\n  Pointer = "pointer"\n  Temp = "temp"\n\n  Add = "add" \n  Sub = "sub" \n  Neg = "neg" \n  Eq = "eq"\n  Lt = "lt" \n  Gt = "gt" \n  And = "and" \n  Or = "or" \n  Not = "not"\n}',y=x.Z.grammar(v,b.y1),k=y.extendSemantics(b.rJ);k.addAttribute("op",{Push:t=>"push",Pop:t=>"pop",Function:t=>"function",Call:t=>"call",Return:t=>"return",Goto:t=>"goto",IfGoto:t=>"if-goto",Label:t=>"label",Add:t=>"add",Sub:t=>"sub",Neg:t=>"neg",Eq:t=>"eq",Lt:t=>"lt",Gt:t=>"gt",And:t=>"and",Or:t=>"or",Not:t=>"not"}),k.addAttribute("segment",{Argument:t=>"argument",Local:t=>"local",Static:t=>"static",Constant:t=>"constant",This:t=>"this",That:t=>"that",Pointer:t=>"pointer",Temp:t=>"temp"}),k.addAttribute("instruction",{StackInstruction(t,e,n){let{op:s}=t,{segment:r}=e,{value:i}=n;return{op:s,segment:r,offset:i}},OpInstruction(t){let{op:e}=t;return{op:e}},FunctionInstruction(t,e,n){let{name:s}=e,{value:r}=n;return{op:"function",name:s,nVars:r}},CallInstruction(t,e,n){let{name:s}=e,{value:r}=n;return{op:"call",name:s,nArgs:r}},ReturnInstruction:t=>({op:"return"}),LabelInstruction(t,e){let{name:n}=e;return{op:"label",label:n}},GotoInstruction(t,e){let{op:n}=t,{name:s}=e;return{op:n,label:s}}}),k.addAttribute("vm",{Vm:t=>({instructions:t.children.map((t=>t.instruction))})}),k.addAttribute("root",{Root(t){let{vm:e}=t;return e}});(0,b.Pz)(y,k);class w{_vmTestInstruction_=!0;do(t){t.vmstep()}*steps(){yield this}}var S=n(1003);function j(t){return void 0!==t.ops}function A(t){return void 0!==t.condition}function C(t){const e=new u;e.span=t.span;for(const n of t.ops){const t=I(n);void 0!==t&&e.addInstruction(t)}return e}function I(t){const{op:e}=t;switch(e){case"tick":return new r.oK;case"tock":return new r.mL;case"ticktock":return new S.r;case"eval":return new r.Mb;case"vmstep":return new w;case"output":return new c;case"set":return new o(t.id,t.value,t.index);case"output-list":return new l(t.spec);case"echo":return new m(t.message);case"clear-echo":return new g;case"loadRom":return new f(t.file);case"load":case"output-file":case"compare-to":return;default:(0,s.qV)(e,`Unknown tst operation ${e}`)}}function T(t,e){for(const n of e.lines)if(j(n))t.addInstruction(C(n));else{const e=A(n)?new p(new h(n.condition.left,n.condition.right,n.condition.op)):new d(n.count);e.span=n.span,t.addInstruction(e);for(const t of n.statements)e.addInstruction(C(t))}return t.reset(),t}},2836:(t,e,n)=>{n.d(e,{Mb:()=>c,l1:()=>o,mL:()=>u,oK:()=>l});var s=n(5524),r=n(5424),i=n(5332),a=n(7468);class o extends a.e{chip=new s.P9;get chipId(){return this.chip.id}clock=r.S.get();static from(t){const e=new o;return(0,i.h)(e,t)}with(t){return this.chip=t,this}hasVar(t){return"time"===t||(t=`${t}`,this.chip.hasIn(t)||this.chip.hasOut(t))}getVar(t,e){if("time"===(t=`${t}`))return this.clock.toString();const n=this.chip.get(t,e);return n?n instanceof s.Gc?n.busVoltage:n.voltage():0}setVar(t,e,n){const r=this.chip.get(t,n);r instanceof s.Gc?r.busVoltage=e:r?.pull(0===e?s.yE:s.lj)}eval(){this.chip.eval()}tick(){this.chip.eval(),this.clock.tick()}tock(){this.chip.eval(),this.clock.tock()}async load(t){await this.chip.load(this.fs,t)}async run(){this.clock.reset(),await super.run()}}class c{_chipTestInstruction_=!0;do(t){t.eval()}*steps(){yield this}}class l{_chipTestInstruction_=!0;do(t){t.tick()}*steps(){yield this}}class u{_chipTestInstruction_=!0;do(t){t.tock()}*steps(){yield this}}},1003:(t,e,n)=>{n.d(e,{o:()=>o,r:()=>c});var s=n(2201),r=n(2369),i=n(7468),a=n(5332);class o extends i.e{cpu;ticks=0;static from(t,e){const n=new o(e);return(0,a.h)(n,t)}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new s.eD(new Int16Array);super(),this.cpu=new r.Z9({ROM:t}),this.reset()}reset(){return super.reset(),this.cpu.reset(),this.ticks=0,this}hasVar(t){return"number"!==typeof t&&!("A"!==t&&"D"!==t&&"PC"!==t&&"time"!==t&&!t.startsWith("RAM"))}getVar(t,e){switch(t){case"A":return this.cpu.A;case"D":return this.cpu.D;case"PC":return this.cpu.PC;case"time":return this.ticks;case"RAM":return void 0===e?0:this.cpu.RAM.get(e)}if("number"===typeof t)return 0;if(t.startsWith("RAM")){const e=Number(t.substring(4,t.length-1));return this.cpu.RAM.get(e)}return 0}setVar(t,e,n){switch(t){case"A":this.cpu.setA(e);break;case"D":this.cpu.setD(e);break;case"PC":this.cpu.setPC(e);break;case"RAM":this.cpu.RAM.set(n??0,e)}}ticktock(){this.ticks+=1,this.cpu.tick()}async load(t){await this.cpu.ROM.load(this.fs,t)}}class c{_cpuTestInstruction_=!0;do(t){t.ticktock()}*steps(){yield this}}},7468:(t,e,n)=>{n.d(e,{e:()=>i});var s=n(7239),r=n(2608);class i{instructions=[];_outputList=[];_log="";fs=new r.Wd;setFileSystem(t){return this.fs=t,this}echo(t){}clearEcho(){}async load(t){}async compareTo(t){}outputFile(t){}outputList(t){this._outputList=t}addInstruction(t){this.instructions.push(t)}reset(){return this._steps=function*(t){for(const e of t.instructions)yield*e.steps(t)}(this),this._step=this._steps.next(),this._log="",this}_steps;_step;get steps(){return void 0===this._steps&&(this.reset(),this._steps=(0,s.kP)(this._steps,"Reset did not initialize steps"),this._step=(0,s.kP)(this._step,"Reset did not find first step")),this._steps}get currentStep(){return this._step?.value}get done(){return this._step?.done??!1}step(){return!!this._step.done||(this._step.value.do(this),this._step=this.steps.next(),!1)}async run(){for(this.reset();!await this.step(););}breakpoints=new Map;addBreakpoint(t,e){this.breakpoints.set(t,e)}clearBreakpoints(){this.breakpoints.clear()}output(){const t=this._outputList.map((t=>t.print(this)));this._log+=`|${t.join("|")}|\n`}header(){const t=this._outputList.map((t=>t.header(this)));this._log+=`|${t.join("|")}|\n`}log(){return this._log}}}}]);